name: Update Video Rules

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ï¼š08:00, 16:00, 00:00 (å¯¹åº” UTC: 00, 08, 16)
    - cron: '0 0,8,16 * * *' 
  workflow_dispatch: # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿éšæ—¶è°ƒè¯•

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»èµ‹äºˆå†™å…¥æƒé™ï¼Œå¦åˆ™ push ä¼šå¤±è´¥
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # å‡çº§åˆ° v4
        with:
          fetch-depth: 0 # æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œç¡®ä¿ git diff å‡†ç¡®

      - name: Set up Python
        uses: actions/setup-python@v5 # å‡çº§åˆ° v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run script
        env:
          PYTHONUNBUFFERED: 1 # å¼€å¯æ— ç¼“å†²æ¨¡å¼ï¼Œå¼ºåˆ¶å®æ—¶è¾“å‡ºæ—¥å¿—
      # âš ï¸ è¯·ç¡®ä¿ä½ çš„ Python è„šæœ¬æ–‡ä»¶åç¡®å®æ˜¯ generate_rules.py  
        run: python generate_rules.py

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f MyVideo.list ]; then
            git add MyVideo.list
            
            # åªæœ‰åœ¨æ–‡ä»¶å†…å®¹çœŸæ­£å‘ç”Ÿå˜åŒ–æ—¶æ‰æäº¤
            if git diff --staged --quiet; then
              echo "No new domains found, skipping commit."
            else
              # ä¿®æ”¹åçš„ Commit å‘½ä»¤ï¼Œæ˜¾å¼æŒ‡å®šä¸ºåŒ—äº¬æ—¶é—´
              # è·å–æ–°å¢çš„è¡Œæ•°ï¼ˆç®€å•ç»Ÿè®¡ï¼Œä»…ä¾›å‚è€ƒï¼‰
              ADDED_LINES=$(git diff --staged MyVideo.list | grep "^+" | grep -v "+++" | wc -l)
              TZ='Asia/Shanghai' git commit -m "ğŸ¤–chore: å¢é‡æ›´æ–°($ADDED_LINESæ¡) $(date +'%Y-%m-%d %H:%M')"
              git push
            fi
          else
            echo "Error: MyVideo.list not generated!"
            exit 1
          fi
